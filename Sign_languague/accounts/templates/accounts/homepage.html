{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang ch·ªß</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="{% static 'accounts/css/homepage.css' %}" />
    <style>
      .message-container {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #2a4074;
        color: #fff;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 16px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 1000;
      }
      /* Khi th√¥ng b√°o ƒë∆∞·ª£c hi·ªÉn th·ªã */
      .message-container.show {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
  </head>

  {% if messages %} {% for message in messages %}
  <div class="message-container">
    <p>{{ message }}</p>
  </div>
  {% endfor %} {% endif %}
  <body>
    <header class="header">
      <div class="header-left">
        <a href="{% url 'home'%}"
          ><img
            src="../../static/accounts/images/pngtree-green-lucky-four-leaf-clover-illustration-image_1218020-removebg-preview.png"
            alt="Logo"
            class="logo"
        /></a>

        <nav class="nav">
          <a href="{% url 'home' %}">D·ªãch Th·ªùi Gian Th·ª±c</a>
          <a href="#">D·ªãch Video</a>
          <a href="{% url 'courses' %}">H·ªçc Ng√¥n Ng·ªØ</a>
        </nav>
      </div>
      <div class="header-right">
        <div class="user-profile">
          <img
            src="{% static 'accounts/images/Luu Cong Vinh.jpg' %}"
            alt="User Avatar"
            class="avatar"
          />
          <div class="dropdown">
            <button class="dropdown-btn">‚ò∞</button>
            <div class="dropdown-content">
              <a href="#">Th√¥ng Tin C√° Nh√¢n</a>
              <a href="{% url 'logout' %}">ƒêƒÉng Xu·∫•t</a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <h1 class="title">Sign Language Translate</h1>

      <!-- Dropdown ƒë·ªÉ ch·ªçn camera -->
      <label for="cameraSelect">Ch·ªçn Camera:</label>
      <select id="cameraSelect"></select>

      <div class="video-container">
        <img src="{% url 'video_feed' %}" id="video" />
        <button id="fullscreenBtn" class="fullscreen-btn">
          <i class="fas fa-expand"></i>
          <!-- Bi·ªÉu t∆∞·ª£ng fullscreen -->
        </button>
        <button id="flipBtn" class="flip-btn">üîÑ</button>

        <!-- N√∫t l·∫≠t ·∫£nh -->
      </div>
      <textarea
        readonly
        id="message"
        class="message-box"
        rows="8"
        cols="50"
        placeholder="Loading history..."
      ></textarea>
    </div>

    <script>
      const videoElement = document.getElementById("video");
      const messageElement = document.getElementById("message");
      const cameraSelect = document.getElementById("cameraSelect");
      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const videoContainer = document.querySelector(".video-container");

      // H√†m ƒë·ªÉ c·∫≠p nh·∫≠t l·ªãch s·ª≠
      function updateHistory() {
        fetch("{% url 'get_user_history' %}")
          .then((response) => response.json())
          .then((data) => {
            let historyText = "";
            data.forEach((history) => {
              historyText += `${history.timestamp}: ${history.word}\n`;
            });
            messageElement.value = historyText;
          })
          .catch((error) => console.log("Error fetching history:", error));
      }
      // G·ªçi updateHistory m·ªói gi√¢y
      setInterval(updateHistory, 1000);
      // H√†m ƒë·ªÉ l·∫•y danh s√°ch c√°c camera
      function getCameras() {
        navigator.mediaDevices.enumerateDevices().then((devices) => {
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );
          cameraSelect.innerHTML = ""; // X√≥a c√°c t√πy ch·ªçn c≈©

          videoDevices.forEach((device, index) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Camera ${index + 1}`;
            cameraSelect.appendChild(option);
          });
        });
      }

      // H√†m ƒë·ªÉ thay ƒë·ªïi camera khi ng∆∞·ªùi d√πng ch·ªçn
      function changeCamera() {
        const selectedDeviceId = cameraSelect.value;

        // Thay ƒë·ªïi URL video_feed v·ªõi camera ID
        videoElement.src = `{% url 'video_feed' %}?device_id=${selectedDeviceId}`;
      }

      // S·ª± ki·ªán thay ƒë·ªïi camera
      cameraSelect.addEventListener("change", changeCamera);

      // T·∫£i danh s√°ch camera khi trang t·∫£i
      getCameras();

      // K√≠ch ho·∫°t ch·∫ø ƒë·ªô fullscreen
      fullscreenBtn.addEventListener("click", () => {
        if (!document.fullscreenElement) {
          if (videoContainer.requestFullscreen) {
            videoContainer.requestFullscreen();
          } else if (videoContainer.webkitRequestFullscreen) {
            // Safari support
            videoContainer.webkitRequestFullscreen();
          } else if (videoContainer.msRequestFullscreen) {
            // IE11 support
            videoContainer.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      });
      // L·∫≠t ·∫£nh
      flipBtn.addEventListener("click", () => {
        // Ki·ªÉm tra tr·∫°ng th√°i hi·ªán t·∫°i, n·∫øu ch∆∞a l·∫≠t th√¨ l·∫≠t, n·∫øu ƒë√£ l·∫≠t th√¨ tr·ªü v·ªÅ
        if (videoElement.style.transform === "scaleX(-1)") {
          videoElement.style.transform = "scaleX(1)"; // L·∫≠t v·ªÅ tr·∫°ng th√°i b√¨nh th∆∞·ªùng
        } else {
          videoElement.style.transform = "scaleX(-1)"; // L·∫≠t video theo chi·ªÅu ngang
        }
      });

      // L·∫Øng nghe s·ª± ki·ªán cu·ªôn trang
      window.addEventListener("scroll", function () {
        const header = document.querySelector(".header");
        if (window.scrollY > 50) {
          // N·∫øu cu·ªôn xu·ªëng qu√° 50px
          header.classList.add("smaller"); // Th√™m l·ªõp "smaller"
        } else {
          header.classList.remove("smaller"); // X√≥a l·ªõp "smaller"
        }
      });
      // L·∫•y ph·∫ßn t·ª≠ th√¥ng b√°o
      document.addEventListener("DOMContentLoaded", function () {
        const messages = document.querySelectorAll(".message-container");

        // Hi·ªÉn th·ªã th√¥ng b√°o v√† sau 3 gi√¢y s·∫Ω ·∫©n n√≥
        messages.forEach((message) => {
          message.classList.add("show");
          setTimeout(() => {
            message.classList.remove("show");
            message.style.display = 'none';
          }, 3000); // Th·ªùi gian hi·ªÉn th·ªã 3 gi√¢y
        });
      });
    </script>
  </body>
</html>
